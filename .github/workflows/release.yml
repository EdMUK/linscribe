name: Release AppImage

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      DEPLOY_GTK_VERSION: "3"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libpulse-dev \
            libsoup-3.0-dev \
            libjson-glib-dev \
            libkeybinder-3.0-dev \
            libxdo-dev \
            glib-networking \
            fuse \
            file

      - name: Install xmake
        run: |
          curl -fsSL https://xmake.io/shget.text | bash
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Build
        run: |
          xmake config -m release
          xmake build

      - name: Download linuxdeploy
        run: |
          curl -fsSL -o linuxdeploy-x86_64.AppImage \
            https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          curl -fsSL -o linuxdeploy-plugin-gtk.sh \
            https://raw.githubusercontent.com/linuxdeploy/linuxdeploy-plugin-gtk/master/linuxdeploy-plugin-gtk.sh
          chmod +x linuxdeploy-x86_64.AppImage linuxdeploy-plugin-gtk.sh

      - name: Build AppImage
        run: |
          # First pass: populate AppDir with binary, desktop file, icon, and GTK libs
          ./linuxdeploy-x86_64.AppImage --appimage-extract-and-run \
            --appdir AppDir \
            --executable build/linux/x86_64/release/linscribe \
            --desktop-file linscribe.desktop \
            --icon-file linscribe.svg \
            --plugin gtk

          # Bundle GIO modules (TLS backend from glib-networking needed for HTTPS)
          GIO_MODULEDIR="$(pkg-config --variable=giomoduledir gio-2.0)"
          APPDIR_GIO="AppDir/usr/lib/x86_64-linux-gnu/gio/modules"
          mkdir -p "$APPDIR_GIO"
          cp "$GIO_MODULEDIR"/*.so "$APPDIR_GIO"/
          gio-querymodules "$APPDIR_GIO"

          # Second pass: produce the AppImage
          OUTPUT="Linscribe-x86_64.AppImage" \
            ./linuxdeploy-x86_64.AppImage --appimage-extract-and-run \
              --appdir AppDir \
              --output appimage

      - name: Rename AppImage
        run: |
          tag="${GITHUB_REF_NAME}"
          mv Linscribe-x86_64.AppImage "Linscribe-${tag}-x86_64.AppImage"

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: Linscribe-*.AppImage
